generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Instance {
  id              String                 @id @default(cuid())
  name            String
  logo            String?
  primaryColor    String
  workflowEnabled Boolean                @default(true)
  customFields    String[]
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  subscriptions   CustomerSubscription[]
  customers       Customer[]
  people          Person[]
  projects        Project[]
  quotes          Quote[]
  recurringTasks  RecurringTask[]
  roles           Role[]
  timeEntries     TimeEntry[]
  workOrders      WorkOrder[]
  users           User[]

  @@map("instances")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  name              String
  avatar            String?
  tenantId          String    // Multi-tenant support
  role              UserRole  @default(GUEST)
  isActive          Boolean   @default(true)
  emailVerified     Boolean   @default(false)
  lastLoginAt       DateTime?
  refreshToken      String?
  refreshTokenExpiry DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  tenant            Instance  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([email, tenantId])
  @@map("users")
}

enum UserRole {
  SUPERADMIN
  ADMIN
  DIRECTOR
  MANAGER
  SUPERVISOR
  TEAMMEMBER
  GUEST
}

model Person {
  id                       String                    @id @default(cuid())
  name                     String
  email                    String                    @unique
  role                     String
  roleId                   String?
  avatar                   String?
  instanceId               String
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  instance                 Instance                  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  assignedRole             Role?                     @relation(fields: [roleId], references: [id])
  projectAssignments       ProjectAssignment[]
  quotesCreated            Quote[]
  recurringTaskAssignments RecurringTaskAssignment[]
  taskAssignments          TaskAssignment[]
  timeEntries              TimeEntry[]
  workApprovalsApproved    WorkApproval[]            @relation("ApprovedApprovals")
  workApprovalsSubmitted   WorkApproval[]            @relation("SubmittedApprovals")
  workCompletionPhotos     WorkCompletionPhoto[]
  workOrderAssignments     WorkOrderAssignment[]
  approvedWorkOrders       WorkOrder[]               @relation("ApprovedWorkOrders")
  completedWorkOrders      WorkOrder[]               @relation("CompletedWorkOrders")

  @@map("people")
}

model Role {
  id                   String              @id @default(cuid())
  name                 String
  color                String
  instanceId           String
  permissions          String[]
  canApproveWork       Boolean             @default(false)
  level                Int                 @default(1)
  requiresApprovalFrom String[]
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  people               Person[]
  recurringTaskRoles   RecurringTaskRole[]
  instance             Instance            @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  workOrderRoles       WorkOrderRole[]

  @@map("roles")
}

model Project {
  id             String              @id @default(cuid())
  name           String
  description    String
  instanceId     String
  customerName   String
  status         String              @default("planning")
  startDate      DateTime
  endDate        DateTime
  budget         Float?
  progress       Int                 @default(0)
  priority       String              @default("medium")
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  assignments    ProjectAssignment[]
  instance       Instance            @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  quotes         Quote[]
  recurringTasks RecurringTask[]
  tasks          Task[]
  workOrders     WorkOrder[]

  @@map("projects")
}

model ProjectAssignment {
  id        String   @id @default(cuid())
  projectId String
  personId  String
  createdAt DateTime @default(now())
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, personId])
  @@map("project_assignments")
}

model Task {
  id             String           @id @default(cuid())
  projectId      String
  name           String
  description    String
  status         String           @default("todo")
  priority       String           @default("medium")
  startDate      DateTime
  endDate        DateTime
  progress       Int              @default(0)
  estimatedHours Float?
  actualHours    Float?
  dependencies   String[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  assignments    TaskAssignment[]
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("tasks")
}

model TaskAssignment {
  id        String   @id @default(cuid())
  taskId    String
  personId  String
  createdAt DateTime @default(now())
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, personId])
  @@map("task_assignments")
}

model WorkOrder {
  id                String                @id @default(cuid())
  projectId         String?
  instanceId        String
  customerName      String
  title             String
  description       String
  status            String                @default("draft")
  priority          String                @default("medium")
  location          String?
  scheduledDate     DateTime
  scheduledTime     String?
  duration          String?
  completedDate     DateTime?
  completedById     String?
  activityLevel     String                @default("medium")
  estimatedDuration Float
  actualDuration    Float?
  isRecurring       Boolean               @default(false)
  recurringTaskId   String?
  completionPhotos  String[]
  completionNotes   String?
  approvalNotes     String?
  approvalStatus    String?
  approvedById      String?
  approvedAt        DateTime?
  reviewNotes       String?
  projectName       String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  approvals         WorkApproval[]
  photos            WorkCompletionPhoto[]
  assignments       WorkOrderAssignment[]
  roleAssignments   WorkOrderRole[]
  approvedBy        Person?               @relation("ApprovedWorkOrders", fields: [approvedById], references: [id])
  completedBy       Person?               @relation("CompletedWorkOrders", fields: [completedById], references: [id])
  instance          Instance              @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  project           Project?              @relation(fields: [projectId], references: [id])
  recurringTask     RecurringTask?        @relation(fields: [recurringTaskId], references: [id])

  @@map("work_orders")
}

model WorkOrderAssignment {
  id          String    @id @default(cuid())
  workOrderId String
  personId    String
  createdAt   DateTime  @default(now())
  person      Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@unique([workOrderId, personId])
  @@map("work_order_assignments")
}

model WorkOrderRole {
  id          String    @id @default(cuid())
  workOrderId String
  roleId      String
  createdAt   DateTime  @default(now())
  role        Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@unique([workOrderId, roleId])
  @@map("work_order_roles")
}

model RecurringTask {
  id                String                    @id @default(cuid())
  instanceId        String
  projectId         String?
  customerName      String
  title             String
  description       String
  frequency         String
  frequencyDetails  String?
  startDate         DateTime
  endDate           DateTime?
  estimatedDuration Float
  activityLevel     String                    @default("medium")
  nextOccurrence    DateTime
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  assignments       RecurringTaskAssignment[]
  completionHistory RecurringTaskCompletion[]
  roleAssignments   RecurringTaskRole[]
  instance          Instance                  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  project           Project?                  @relation(fields: [projectId], references: [id])
  workOrders        WorkOrder[]

  @@map("recurring_tasks")
}

model RecurringTaskAssignment {
  id              String        @id @default(cuid())
  recurringTaskId String
  personId        String
  createdAt       DateTime      @default(now())
  person          Person        @relation(fields: [personId], references: [id], onDelete: Cascade)
  recurringTask   RecurringTask @relation(fields: [recurringTaskId], references: [id], onDelete: Cascade)

  @@unique([recurringTaskId, personId])
  @@map("recurring_task_assignments")
}

model RecurringTaskRole {
  id              String        @id @default(cuid())
  recurringTaskId String
  roleId          String
  createdAt       DateTime      @default(now())
  recurringTask   RecurringTask @relation(fields: [recurringTaskId], references: [id], onDelete: Cascade)
  role            Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([recurringTaskId, roleId])
  @@map("recurring_task_roles")
}

model RecurringTaskCompletion {
  id              String        @id @default(cuid())
  recurringTaskId String
  date            DateTime
  workOrderId     String
  completedBy     String
  duration        Float
  createdAt       DateTime      @default(now())
  recurringTask   RecurringTask @relation(fields: [recurringTaskId], references: [id], onDelete: Cascade)

  @@map("recurring_task_completions")
}

model TimeEntry {
  id            String    @id @default(cuid())
  personId      String
  instanceId    String
  clockInTime   DateTime
  clockOutTime  DateTime?
  location      String?
  clockInNotes  String?
  clockOutNotes String?
  totalHours    Float?
  workOrderIds  String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  instance      Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  person        Person    @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

model WorkCompletionPhoto {
  id          String    @id @default(cuid())
  workOrderId String
  personId    String
  photoUrl    String
  caption     String?
  timestamp   DateTime  @default(now())
  createdAt   DateTime  @default(now())
  person      Person    @relation(fields: [personId], references: [id], onDelete: Cascade)
  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("work_completion_photos")
}

model WorkApproval {
  id              String    @id @default(cuid())
  workOrderId     String
  submittedById   String
  submittedAt     DateTime  @default(now())
  status          String    @default("pending")
  approvedById    String?
  approvedAt      DateTime?
  notes           String?
  photos          String[]
  completionNotes String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  approvedBy      Person?   @relation("ApprovedApprovals", fields: [approvedById], references: [id])
  submittedBy     Person    @relation("SubmittedApprovals", fields: [submittedById], references: [id])
  workOrder       WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)

  @@map("work_approvals")
}

model Quote {
  id                     String          @id @default(cuid())
  quoteNumber            String          @unique
  instanceId             String
  customerName           String
  customerEmail          String?
  customerPhone          String?
  customerAddress        String?
  title                  String
  description            String
  status                 String          @default("draft")
  priority               String?         @default("medium")
  subtotal               Float
  taxRate                Float           @default(0)
  taxAmount              Float           @default(0)
  discountRate           Float?
  discountAmount         Float?
  totalAmount            Float
  validUntil             DateTime
  notes                  String?
  termsAndConditions     String?
  createdById            String
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  sentAt                 DateTime?
  approvedAt             DateTime?
  rejectedAt             DateTime?
  convertedToProjectId   String?
  convertedToWorkOrderId String?
  attachments            String[]
  lineItems              QuoteLineItem[]
  project                Project?        @relation(fields: [convertedToProjectId], references: [id])
  createdBy              Person          @relation(fields: [createdById], references: [id])
  instance               Instance        @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@map("quotes")
}

model QuoteLineItem {
  id          String   @id @default(cuid())
  quoteId     String
  description String
  quantity    Float
  unitPrice   Float
  discount    Float?   @default(0)
  tax         Float?   @default(0)
  total       Float
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  quote       Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_line_items")
}

model Customer {
  id             String                @id @default(cuid())
  name           String
  companyName    String
  email          String                @unique
  phone          String?
  address        String?
  instanceId     String
  subscriptionId String?               @unique
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  instance       Instance              @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  subscription   CustomerSubscription? @relation(fields: [subscriptionId], references: [id])

  @@map("customers")
}

model SubscriptionPlan {
  id            String                 @id @default(cuid())
  name          String
  description   String
  price         Float
  billingCycle  String
  features      String[]
  maxUsers      Int
  maxProjects   Int
  maxClients    Int
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  subscriptions CustomerSubscription[]

  @@map("subscription_plans")
}

model CustomerSubscription {
  id              String           @id @default(cuid())
  customerId      String?          @unique
  planId          String
  instanceId      String
  status          String           @default("active")
  startDate       DateTime
  endDate         DateTime?
  billingEmail    String
  paymentMethod   Json?
  nextBillingDate DateTime
  amount          Float
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  instance        Instance         @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  customer        Customer?

  @@map("customer_subscriptions")
}
